# AIKit.MarkItDown Enhancement Plan
## Overview
This plan outlines the steps to enhance the AIKit.MarkItDown C# wrapper to support all features of the Microsoft MarkItDown library, including advanced conversions for PDF, PowerPoint, Word, Excel, Images (EXIF + OCR), Audio (EXIF + transcription), HTML, Text formats (CSV/JSON/XML), ZIP files, YouTube URLs, EPubs, and more.

## Current State vs. MarkItDown Capabilities
- **Supported in Current Wrapper**: Basic file-to-Markdown conversion for PDFs (via streams) and other formats (via file paths). Returns only plain text.
- **Missing Features**: Azure Doc Intel for better PDF/OCR, LLM integration for images/audio, plugin system, full result objects (title + metadata), stream/URL conversion, configuration options, and comprehensive format support (e.g., YouTube, EPub, ZIP iteration).
- **Key Gaps**: No way to pass conversion parameters (e.g., LLM models, Azure endpoints), limited to file paths, and ignores advanced Python features like plugins or metadata.

## Enhancement Plan
This plan is divided into phases for incremental implementation. It focuses on extending the C# API while leveraging the Python library's full capabilities. All changes will maintain backward compatibility where possible.

### Phase 1: Core API and Result Object Expansion (High Priority)
**Goal**: Extend the conversion API to support configurations, return richer results, and handle streams/URLs.

1. **Create New Classes**:
   - Add `MarkDownResult` class to return `Text`, `Title`, and `Metadata` (Dictionary<string, object>).
   - Add `MarkDownConfig` class with properties for:
     - `DocIntelEndpoint` (string): Azure Document Intelligence endpoint.
     - `LlmClient` (PyObject): Python OpenAI client instance.
     - `LlmModel` (string): LLM model name (e.g., "gpt-4o").
     - `LlmPrompt` (string): Custom prompt for LLM features.
     - `KeepDataUris` (bool): Preserve image data URIs.
     - `EnablePlugins` (bool): Enable 3rd-party plugins.

2. **Update MarkDownConverter.cs**:
   - Modify `Convert(string filePath)` to return `MarkDownResult` instead of string.
   - Add overloads:
     - `MarkDownResult Convert(string filePath, MarkDownConfig config = null)`
     - `MarkDownResult Convert(Stream stream, string extension, MarkDownConfig config = null)`
     - `MarkDownResult ConvertUri(string uri, MarkDownConfig config = null)`
   - In the Python integration, pass config as `**kwargs` to `md.convert()`. For example:
     ```csharp
     var kwargs = new PyDict();
     if (config != null) {
         // Populate kwargs from config properties
     }
     var result = md.convert(filePath, kwargs);
     return new MarkDownResult { Text = result.text_content, Title = result.title, Metadata = result.metadata };
     ```
   - Handle PyObject creation for LLM clients (e.g., import OpenAI in Python context).

3. **Update Tests**:
   - Modify `MarkDownConverterTests.cs` to expect `MarkDownResult`.
   - Add tests for new overloads with sample configs.

**Estimated Effort**: 2-3 days. **Dependencies**: None new in C#; relies on existing pythonnet. **Status**: COMPLETED

### Phase 2: Dependency and Installation Updates (Medium Priority) - COMPLETED
**Goal**: Ensure all MarkItDown features are installable and available.

1. **Update install.ps1**:
   - Install all optional Python dependencies: `azure-ai-documentintelligence`, `openai`, `openai-whisper`, `torch`, `torchaudio`, `yt-dlp`, `ebooklib`, `extract-msg`, etc.
   - Add checks for Python version (3.8+) and verify installations.
   - Include plugin support (e.g., install common plugins if available).

2. **Update README.md**:
   - Document new config options, required Python packages, and Azure/OpenAI setup.

**Estimated Effort**: 1 day. **Challenges**: Ensuring all packages install correctly on Windows (test with different Python versions). **Status**: COMPLETED

### Phase 3: Advanced Feature Integration (Medium-High Priority)
**Goal**: Add support for Azure Doc Intel, LLM, and plugins.

1. **Azure Document Intelligence**:
   - In `MarkDownConfig`, add `DocIntelKey` (string) for authentication.
   - Pass to Python as kwargs; MarkItDown handles the integration automatically for PDFs/images.

2. **LLM Integration**:
   - Allow users to provide an OpenAI API key or client.
   - In C#, create Python OpenAI client: `Py.Import("openai"); var client = openai.OpenAI(api_key=key);`
   - Pass as `llm_client` kwarg for image descriptions, audio transcription, etc.

3. **Plugin System**:
   - Add `Plugins` (List<string>) to `MarkDownConfig` for plugin names.
   - Load plugins in Python context before conversion.

4. **Format-Specific Enhancements**:
   - **Images/Audio**: Enable OCR/transcription via config (MarkItDown handles via Tesseract/Whisper).
   - **ZIP/YouTube/EPub**: Supported natively once streams/URLs are added.
   - **Text Formats**: Enhanced table rendering for CSV via pandas.

**Estimated Effort**: 3-4 days. **Challenges**: Managing PyObject lifetimes; secure credential handling (avoid hardcoding keys).

### Phase 4: Error Handling, Performance, and Testing (Medium Priority)
**Goal**: Robustify the wrapper for production use.

1. **Error Handling**:
   - Enhance exception translation: Map Python errors to specific C# exceptions (e.g., `MarkItDownConversionException`).
   - Add partial failure handling (e.g., for ZIP files with mixed content).

2. **Performance Optimizations**:
   - Add async support for long conversions (e.g., audio transcription).
   - Memory management for large files/streams.

3. **Testing**:
   - Expand `MarkDownConverterTests.cs` with:
     - All formats (use sample files from MarkItDown repo).
     - Config variations (Azure, LLM).
     - Stream/URL tests.
   - Add E2E tests in `E2eTests.cs` for real files.

**Estimated Effort**: 2-3 days. **Tools**: Use xUnit for automated tests; validate with `dotnet test`.

### Phase 5: Documentation and Examples (Low Priority)
**Goal**: Make the enhanced wrapper user-friendly.

1. **Update Documentation**:
   - Add examples for each format (e.g., PDF with Azure Doc Intel, images with LLM).
   - Document setup for Azure/OpenAI credentials.

2. **Sample Code**:
   - Add a `Program.cs` example in the AppHost project demonstrating advanced usage.

**Estimated Effort**: 1 day.

## Implementation Order and Dependencies
- Start with Phase 1 (core API) as it's foundational.
- Phase 2 can run in parallel for dependency setup.
- Phases 3-5 build on the first two.
- **Total Timeline**: 1-2 weeks for full implementation.
- **Prerequisites**: Access to Azure/OpenAI APIs for testing advanced features; ensure Python environment is set up via `install.ps1`.

## Potential Challenges and Mitigations
- **Python Object Management**: Use `using` blocks for Py.GIL() and careful PyObject disposal to avoid memory leaks.
- **Security**: Never store credentials in code; use environment variables or secure config.
- **Compatibility**: Test on .NET 10.0 (current target); ensure pythonnet 3.0.5 supports all features.
- **Large Files**: Add size limits and streaming for memory efficiency.
- **Testing Data**: Source sample files from MarkItDown's test suite or create minimal ones.

This plan will bring the C# wrapper to parity with MarkItDown's full feature set, enabling conversions for all listed formats with advanced capabilities like OCR, transcription, and AI enhancements.